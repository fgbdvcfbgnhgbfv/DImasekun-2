local intermissionTime = 30 -- –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –º–∞—Ç—á–µ–º
local roundTime = 300 -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞—É–Ω–¥–∞
local caer = game.ReplicatedStorage.Events.Guievent
local custartevent = game.ReplicatedStorage.Events.CustardEvents.Custartup
local KillersFolder = workspace.Players:WaitForChild("Killer")
local SurvivorsFolder = workspace.Players:WaitForChild("Survivors")
local minPlayers = 2
local killerIndex = 1 -- —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å —É–±–∏–π—Ü—ã
local mapIndex = 1 -- —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –∫–∞—Ä—Ç—ã
local morhpevent = game.ReplicatedStorage.Events.Morphevent
local lastgs = game.ReplicatedStorage.Events.Lastgood.GuiEventG
local Players = game:GetService("Players")
local currentMap = nil
lastmanvarible = false
local timeevent = game.ReplicatedStorage.Events.Timeevent
local guimagevent = game.ReplicatedStorage.Events.Gui.ImageMapGui
local NeutralsFolder = workspace.Players:WaitForChild("Neutral")
local PlayerChoseEvent = game.ReplicatedStorage.Events:WaitForChild("PlayerChoseEvent")
local chosenPlayers = {}
local solomusic = game.ReplicatedStorage.Events.SoloMusic
local Maps = {
	--game.ReplicatedStorage.Maps.MapForTesting,
	game.ReplicatedStorage.Maps.UltraBrawl,
	game.ReplicatedStorage.Maps.Dimamap,
	game.ReplicatedStorage.Maps.BulluTown,
	game.ReplicatedStorage.Maps.GrysaMap,
}

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è "–ø–æ—Å–ª–µ–¥–Ω–∏–π —á–µ–ª–æ–≤–µ–∫" ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞:
-- –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –∫–∏–ª–ª–µ—Ä –∏ —Ä–æ–≤–Ω–æ 1 –Ω–µ-–∫–∏–ª–ª–µ—Ä (–≤—ã–∂–∏–≤—à–∏–π –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª) –ò —ç—Ç–æ—Ç –Ω–µ-–∫–∏–ª–ª–µ—Ä - –°–µ—Ä–≥–µ–π
local function checkLastManTrigger()
	if lastmanvarible then return end -- —É–∂–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ

	local k = #KillersFolder:GetChildren()
	local s = #SurvivorsFolder:GetChildren()
	local n = #NeutralsFolder:GetChildren()

	-- –£—Å–ª–æ–≤–∏–µ: –µ—Å—Ç—å –∫–∏–ª–ª–µ—Ä—ã –∏ —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω –Ω–µ-–∫–∏–ª–ª–µ—Ä
	if k >= 1 and (s + n) == 1 then
		-- –ù–∞—Ö–æ–¥–∏–º –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –Ω–µ-–∫–∏–ª–ª–µ—Ä–∞
		local lastMan = nil
		if s == 1 then
			lastMan = SurvivorsFolder:GetChildren()[1]
		elseif n == 1 then
			lastMan = NeutralsFolder:GetChildren()[1]
		end

		-- –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –°–µ—Ä–≥–µ–π
		if lastMan and lastMan:FindFirstChild("Sergay") then
			-- —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–µ–ª–æ–≤–µ–∫
			currentRoundTime = 194 -- –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –≤—Ä–µ–º—è
			lastgs:FireAllClients()
			lastmanvarible = true

			-- üî• –í–∫–ª—é—á–∞–µ–º —Å–æ–ª—å–Ω—É—é –º—É–∑—ã–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –°–µ—Ä–≥–µ—è
			solomusic:FireAllClients("Sergay")

			-- üî• –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –•–ü –°–µ—Ä–≥–µ—è –¥–æ 165 –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ—á–∏–º
			local humanoid = lastMan:FindFirstChildOfClass("Humanoid")
			if humanoid then
				humanoid.MaxHealth = 200
				humanoid.Health = 200
				print("[SERGAY SOLO] –•–ü —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ 200! –°–µ—Ä–≥–µ–π –≥–æ—Ç–æ–≤ –∫ –±–æ—é!")
			else
				warn("[SERGAY SOLO] –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ Humanoid —É –°–µ—Ä–≥–µ—è")
			end

			print("[INFO] –°–µ—Ä–≥–µ–π –≤ —Å–æ–ª–æ! –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ–ª—å–Ω–∞—è –º—É–∑—ã–∫–∞ –∏ –±—É—Å—Ç –•–ü. " .. k .. " killer(s) vs –°–µ—Ä–≥–µ–π")
		elseif lastMan and lastMan:FindFirstChild("tmugrobot") then
			currentRoundTime = 120 -- –ø—Ä–æ–¥–ª–µ–≤–∞–µ–º –≤—Ä–µ–º—è
			lastgs:FireAllClients()
			lastmanvarible = true

			solomusic:FireAllClients("tmugrobot")

			local humanoid = lastMan:FindFirstChildOfClass("Humanoid")
			if humanoid then
				humanoid.MaxHealth = 140
				humanoid.Health = 140
				lastMan.Peregnev.Value = - 20
			end
		else
			-- –ï—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ –°–µ—Ä–≥–µ–π, –ø—Ä–æ—Å—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º lastman –±–µ–∑ –º—É–∑—ã–∫–∏ –∏ –±—É—Å—Ç–∞
			local humanoid = lastMan:FindFirstChildOfClass("Humanoid")
			if humanoid then
				humanoid.MaxHealth = 140
				humanoid.Health = 140
			end
			currentRoundTime = 120
			solomusic:FireAllClients("OneLast")
			lastgs:FireAllClients()
			lastmanvarible = true
			print("[INFO] Last-man trigger: " .. k .. " killer(s) vs 1 non-killer (–Ω–µ –°–µ—Ä–≥–µ–π)")
		end
	end
end

PlayerChoseEvent.OnServerEvent:Connect(function(player)
	chosenPlayers[player.UserId] = true
	print("[CHOICE] –ò–≥—Ä–æ–∫ –≤—ã–±—Ä–∞–ª –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", player.Name)
end)

local function checkWinner()
	local killers = KillersFolder:GetChildren()
	local survivors = SurvivorsFolder:GetChildren()
	local neutrals = NeutralsFolder:GetChildren()

	-- üèÜ –§—É–Ω–∫—Ü–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≥—Ä–∞–¥—ã –ø–æ–±–µ–¥–∏—Ç–µ–ª—é
	local function giveWin(player)
		if not player then return end

		local leaderstats = player:FindFirstChild("leaderstats")
		if not leaderstats then
			warn("[giveWin] " .. player.Name .. " –Ω–µ –∏–º–µ–µ—Ç leaderstats!")
			return
		end

		local wins = leaderstats:FindFirstChild("Wins")
		local tokens = leaderstats:FindFirstChild("Tokens")

		if wins then
			wins.Value += 1
			print("üèÜ " .. player.Name .. " –ø–æ–ª—É—á–∏–ª –ø–æ–±–µ–¥—É! –¢–µ–ø–µ—Ä—å Wins =", wins.Value)
		else
			warn("[giveWin] –£ " .. player.Name .. " –Ω–µ—Ç Wins!")
		end

		if tokens then
			tokens.Value += 500
			print("üí∞ " .. player.Name .. " –ø–æ–ª—É—á–∏–ª 30 —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ –ø–æ–±–µ–¥—É! –¢–µ–ø–µ—Ä—å Tokens =", tokens.Value)
		else
			warn("[giveWin] –£ " .. player.Name .. " –Ω–µ—Ç Tokens!")
		end
	end

	-- üß© –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞ –∏–∑ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
	local function safeGetPlayerFromCharacter(character)
		local player = game.Players:GetPlayerFromCharacter(character)
		if not player then
			warn("[safeGetPlayerFromCharacter] –ù–µ –Ω–∞–π–¥–µ–Ω –∏–≥—Ä–æ–∫ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:", character.Name)
		end
		return player
	end

	-- ‚ö™ –ù–∏—á—å—è ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–∂–∏–ª
	if #killers == 0 and #survivors == 0 and #neutrals == 0 then
		print("‚ö™ –ù–∏—á—å—è ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–∂–∏–ª.")
		return
	end

	-- üü¢ –ü–æ–±–µ–¥–∞ –≤—ã–∂–∏–≤—à–∏—Ö (–∫–∏–ª–ª–µ—Ä –º—ë—Ä—Ç–≤ –∏ –≤—ã–∂–∏–≤—à–∏–µ –∂–∏–≤—ã)
	if #killers == 0 and #survivors > 0 then
		print("üü¢ –ü–æ–±–µ–¥–∞ –≤—ã–∂–∏–≤—à–∏—Ö!")
		for _, plr in ipairs(survivors) do
			giveWin(safeGetPlayerFromCharacter(plr))
		end
		return
	end

	-- üòê –ü–æ–±–µ–¥–∞ –Ω–µ–π—Ç—Ä–∞–ª–∞ (–µ—Å–ª–∏ –∫–∏–ª–ª–µ—Ä –º—ë—Ä—Ç–≤, –≤—ã–∂–∏–≤—à–∏—Ö –Ω–µ—Ç –∏ –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω –Ω–µ–π—Ç—Ä–∞–ª)
	if #killers == 0 and #survivors == 0 and #neutrals == 1 then
		print("üòê –ü–æ–±–µ–¥–∞ –Ω–µ–π—Ç—Ä–∞–ª–∞!")
		giveWin(safeGetPlayerFromCharacter(neutrals[1]))
		return
	end

	-- üî¥ –ü–æ–±–µ–¥–∞ –∫–∏–ª–ª–µ—Ä–∞ (–µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è –æ–¥–∏–Ω)
	if #killers > 0 and #survivors == 0 and #neutrals == 0 then
		print("üî¥ –ü–æ–±–µ–¥–∞ –∫–∏–ª–ª–µ—Ä–∞!")
		for _, plr in ipairs(killers) do
			giveWin(safeGetPlayerFromCharacter(plr))
		end
		return
	end

	-- üïí –ü–æ–±–µ–¥–∞ –≤—ã–∂–∏–≤—à–∏—Ö –ø–æ —Ç–∞–π–º–µ—Ä—É (–µ—Å–ª–∏ –≤—Ä–µ–º—è –≤—ã—à–ª–æ –∏ –µ—Å—Ç—å –≤—ã–∂–∏–≤—à–∏–µ)
	if currentRoundTime and currentRoundTime <= 0 then
		if #survivors > 0 then
			print("üïí –í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –≤—ã–∂–∏–≤—à–∏–µ –ø–æ–±–µ–¥–∏–ª–∏!")
			for _, plr in ipairs(survivors) do
				giveWin(safeGetPlayerFromCharacter(plr))
			end
		elseif #killers > 0 and #survivors == 0 and #neutrals == 0 then
			-- üî¥ –î–û–ë–ê–í–õ–ï–ù–û: –ü–æ–±–µ–¥–∞ –∫–∏–ª–ª–µ—Ä–∞ –ø–æ —Ç–∞–π–º–µ—Ä—É, –µ—Å–ª–∏ –Ω–µ—Ç –≤—ã–∂–∏–≤—à–∏—Ö –∏ –Ω–µ–π—Ç—Ä–∞–ª–æ–≤
			print("üïí –í—Ä–µ–º—è –≤—ã—à–ª–æ ‚Äî –∫–∏–ª–ª–µ—Ä—ã –ø–æ–±–µ–¥–∏–ª–∏!")
			for _, plr in ipairs(killers) do
				giveWin(safeGetPlayerFromCharacter(plr))
			end
		end
		return
	end
end

local function trashdestroy()
	game.Workspace.trash:Destroy()
	task.wait(0.1)
	local newtrash = Instance.new("Folder")
	newtrash.Name = "trash"
	newtrash.Parent = game.Workspace
end

local function getSpawnParts(name)
	local spawns = {}
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("BasePart") and obj.Name == name then
			table.insert(spawns, obj)
		end
	end
	return spawns
end

-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –∏ —Ç–µ–ª–µ–ø–æ—Ä—Ç
local function assignPlayersToFolders()
	for _, folder in pairs({KillersFolder, SurvivorsFolder}) do
		for _, model in ipairs(folder:GetChildren()) do
			model.Parent = workspace
		end
	end

	local allPlayers = Players:GetPlayers()
	if #allPlayers == 0 then return end

	local killer = allPlayers[killerIndex]
	killerIndex += 1
	if killerIndex > #allPlayers then
		killerIndex = 1
	end
	local neutral
	if #allPlayers > 3 then
		neutral = allPlayers[math.random(1, #allPlayers)]
		while neutral == killer do
			neutral = allPlayers[math.random(1, #allPlayers)]
		end
	end

	-- –ù–∞—Ö–æ–¥–∏–º —Å–ø–∞–≤–Ω—ã
	local survivorSpawns = getSpawnParts("spawnpartsurvavor")
	local killerSpawns = getSpawnParts("spawnpartkiller")

	local survSpawnIndex = 1
	local killerSpawnIndex = 1

	for _, player in ipairs(allPlayers) do
		local char = player.Character or player.CharacterAdded:Wait()
		wait(0.5)
		if player == killer then
			char.Parent = KillersFolder
			caer:FireClient(player, "killer")

		elseif player == neutral then
			char.Parent = NeutralsFolder
			caer:FireClient(player, "neutral")
		else
			char.Parent = SurvivorsFolder
			caer:FireClient(player, "survivor")
		end
	end

	-- üïê –ñ–¥—ë–º, –ø–æ–∫–∞ –≤—Å–µ –≤—ã–±–µ—Ä—É—Ç, –∏–ª–∏ –º–∞–∫—Å–∏–º—É–º 40 —Å–µ–∫—É–Ω–¥
	local allPlayers = Players:GetPlayers()
	local totalPlayers = #allPlayers
	local elapsed = 0
	local maxWait = 30

	print("[INFO] –û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (–º–∞–∫—Å. 40 —Å–µ–∫)...")

	while elapsed < maxWait do
		local chosenCount = 0
		for _, plr in ipairs(allPlayers) do
			if chosenPlayers[plr.UserId] then
				chosenCount += 1
			end
		end

		if chosenCount >= totalPlayers then
			print("[INFO] –í—Å–µ –∏–≥—Ä–æ–∫–∏ –≤—ã–±—Ä–∞–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!")
			break
		end

		task.wait(1)
		elapsed += 1
	end

	-- –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ—Ö
	for _, player in ipairs(allPlayers) do
		local char = player.Character
		if char and char:FindFirstChild("HumanoidRootPart") then
			if char.Parent == KillersFolder and #killerSpawns > 0 then
				local spawn = killerSpawns[killerSpawnIndex]
				char:WaitForChild("HumanoidRootPart").CFrame = spawn.CFrame + Vector3.new(0, 5, 0)
				killerSpawnIndex = killerSpawnIndex % #killerSpawns + 1
			elseif char.Parent == SurvivorsFolder and #survivorSpawns > 0 then
				local spawn = survivorSpawns[survSpawnIndex]
				char:WaitForChild("HumanoidRootPart").CFrame = spawn.CFrame + Vector3.new(0, 5, 0)
				survSpawnIndex = survSpawnIndex % #survivorSpawns + 1
			elseif char.Parent == NeutralsFolder and #survivorSpawns > 0 then
				local spawn = survivorSpawns[survSpawnIndex]
				char:WaitForChild("HumanoidRootPart").CFrame = spawn.CFrame + Vector3.new(0, 5, 0)
				survSpawnIndex = survSpawnIndex % #survivorSpawns + 1
			end
		end
	end

	print("[INFO] –¢–µ–ª–µ–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.")
	-- –ü–æ—Å–ª–µ —Ç–µ–ª–µ–ø–æ—Ä—Ç–∞ –º–æ—Ä—Ñ–∏–º –∏–≥—Ä–æ–∫–æ–≤
	for _, player in ipairs(allPlayers) do
		morhpevent:FireClient(player)
	end
	chosenPlayers = {}
	print("üó° –£–±–∏–π—Ü–∞: " .. killer.Name)
end

-- –°–æ–±—ã—Ç–∏–µ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
custartevent.Event:Connect(function(timed)
	print("[EVENT] Custartevent fired, reducing round time by 40")
	currentRoundTime = math.max(currentRoundTime - timed, 0)
end)

-- –ì–ª–∞–≤–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
while true do
	while #Players:GetPlayers() < minPlayers do
		timeevent:FireAllClients(0) -- –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å, —á—Ç–æ —Ç–∞–π–º–µ—Ä = 0
		task.wait(1) -- –¥–∞—ë–º 1 —Å–µ–∫—É–Ω–¥—É –ø–∞—É–∑—ã
	end

	-- ‚è≥ –ò–Ω—Ç–µ—Ä–º–∏—Å—Å–∏—è
	for i = intermissionTime, 1, -1 do
		wait(1)
		visibletime.Value = i
		timeevent:FireAllClients(i)
	end

	-- ‚åõ –§–∞–∑–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–∫–∞—Ä—Ç–∞ + –ø–µ—Ä—Å–æ–Ω–∞–∂–∏)
	print("[INFO] –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏–≥—Ä–æ–∫–æ–≤...")

	for _, player in ipairs(Players:GetPlayers()) do
		if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
			player.CharacterAdded:Wait()
			repeat wait() until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		end
	end

	print("[INFO] –í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")

	-- ‚åõ –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
	lastmanvarible = false
	currentMap = Maps[mapIndex]:Clone()
	mapIndex += 1
	if mapIndex > #Maps then
		mapIndex = 1
	end
	currentMap.Parent = game.Workspace
	guimagevent:FireAllClients(currentMap.Name)
	print("[INFO] –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:", currentMap.Name)

	wait(2)
	assignPlayersToFolders()
	-- ‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç —Ä–∞—É–Ω–¥–∞
	currentRoundTime = roundTime

	-- ‚è± –†–∞—É–Ω–¥ –∏–¥—ë—Ç
	while currentRoundTime > 0 do
		wait(1)
		currentRoundTime -= 1
		timeevent:FireAllClients(currentRoundTime)
		visibletime.Value = currentRoundTime

		checkLastManTrigger()

		-- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã –≤–æ –≤—Ä–µ–º—è —Ä–∞—É–Ω–¥–∞
		if #KillersFolder:GetChildren() == 0 then break end
		if #SurvivorsFolder:GetChildren() == 0 and #NeutralsFolder:GetChildren() == 0 then
			break 
		end
	end

	-- üîö –ö–æ–Ω–µ—Ü —Ä–∞—É–Ω–¥–∞
	checkWinner()
	trashdestroy()
	currentMap:Destroy()
	wait(2)

	-- –†–µ—Å–µ—Ç –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
	for _, player in ipairs(Players:GetPlayers()) do
		if player.Character then
			player:LoadCharacter()
		end
	end

	wait(3)
end

